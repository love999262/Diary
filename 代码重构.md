# 代码重构

- 对于某些一直需要维护的大型项目来说,代码重构是绕不开的事情,尤其是项目前期因为编码人员能力有限或者是赶工期,难免会出现一些不严谨的代码,没有为之后扩展考虑,或者是代码违反一些应该遵守的原则,模块划分混乱等现象,(某知名视频网站层出现十几万行JS代码放在一个JS文件的情况)当这些问题堆积起来之后,在项目逐渐成型,并且又没有太多的新任务的时候,又可以考虑将项目中的代码按照良好的设计模式进行重构了,重构的过程,不论是对于重构者个人或者对于公司项目来说,都是一件能获得很多帮助的事情.

- 提炼函数

几乎所有程序员都知道,对于函数来说,要将变化的地方与不变的地方分离出来,如果一个一个函数的体积超级大,那么这个函数一定有可以分离的地方,我们可以将一些公共的功能提炼成很多的小函数,这样做的好处有:

1. 避免出现超大函数,以免在以后的更改中引入某些不知道的BUG.
2. 提炼公共函数,增强了函数的复用性.
3. 提炼出来的函数更加容易被复写.
4. 对提炼出来的功能函数进行良好的命名以取代一些不必要的注释.

- 合并重复的条件片段

如果函数体内有一些条件分支语句,而这些条件分支语句内散步了一些重复的代码那么我们就可以进行合并去重的工作,假设我们有一个分页函数paging(),该函数接受参数curPage代表要跳转到的页码,在跳转之前,我们需要判断curPage的值以避免出现不正常的现象.

```js
let paging = function(curPage) {
    if(curPage <= 0) {
        curPage = 0;
        jump(curPage);
    } else if(curPage >= totalPage) {
        curPage = totalPage;
        jump(curPage);
    } else {
        jump(curPage);
    }
}
```

这里有一个函数jpmp()在所有的条件分支都出现了,那么我们完全可以在判断赋值完之后只需写一次即可:

```js
let paging = function(curPage) {
    if(curPage <= 0) {
        curPage = 0;
    } else if(curPage >= totalPage) {
        curPage = totalPage;
    }
    jump(curPage);
}
```

- 将条件分支语句提炼成函数

在程序中,复杂的条件分支语句是造成程序难以阅读的一个重要的原因,并且非常容易导致一个庞大的函数.假设有一个需求是计算商品价格,如果处于夏季(6-9月),那么商品就打八折.

```js
var getPrice = function() {
    let date = new Date();
    if(date.getMonth() >= 6 && date.getMonth() <= 9) {
        return price * 0.8;
    }
    return price
};
```

这段代码的意图很简单,但是因为里面有一个条件语句,所以阅读代码的人得需要多花点功夫才能理解代码到底要干嘛,如果将条件语句提炼成函数,以函数名的方式来代替,就可以起到一目了然的作用:

```js
var isSummer = function() {
    var date = new Date();
    return date.getMonth() >= 6 && date.getMonth() <= 9;
},
var getPrice = function() {
    if(isSummer()) {
        return price * 0.8;
    }
    return price
};
```

- 循环

在程序中,有一些地方的代码,尤其是负责同级别功能的函数,其实并不需要每次都手动创建或者调用,我们可以用循环的方式来调用以达到减少代码量的效果.

- 提前让函数退出以代替嵌套的条件分支

对于一些嵌套的if语句来说,如果嵌套的层级越多,那么代码将变得越不可读:

```js
let del = function(obj) {
    let ret;
    if(!obj.isReadyOnly) {
        if(obj.isFolder) {
            ret = deleteFolder(obj);
        } else if(obj.isFile) {
            ret = deleteFile(obj);
        }
    }
    return ret
};
```

嵌套的if语句要尽量避免,以为没多增加一层if将会是代码的不可读性同样也多增加一层,试想下如果有五百个if嵌套,那么这段代码基本上就可以不用维护了.
其实函数的出口并不会只有一个,如果说运行完我这里之后其他的地方与我无关,那么我就可以将函数在执行完我这里之后立刻return出去,这样做可以避免之后的维护者阅读了半天不相关的代码才发现这些代码不相关.

以上代码的改进:

```js
if(obj.isReadyOnly) {
    return;
}
if(obj.isFloder) {
    return deleteFolder(obj);
}
if(obj.isFile) {
    return deleteFile(obj);
}
```

- 传递对象参数代替过长的参数列表

对于这一点其实已经不用说太多了,对象参数的好处有太多了: 无序性,非必要性,默认值...比方说:

```js
$.ajax({
    url: 'www.xxx.xxx',
    type: 'get', // 可选默认get
    success: function(res) {
        //
    }
});
```

这里面的参数都是可选的并且无序的,而且参数的默认值也都是最常用的,如果有特殊情况需要定义一些参数的默认值只需要去手动设置即可.

- 尽可能的减少参数数量

如果调用一个函数需要传入十八个参数,那么这个函数不是过于庞大就是设计冗余,我们在定义参数的时候一定要考虑这些参数是否是必要的,因为参数增加了不确定性,最受人喜爱的函数当然是那种不需要任何参数的函数,但是在实际的开发中,总会有一些函数不可避免的有一个或者多个参数需要传入,但是我们应该尽可能的减少参数:

```js
function draw(w,h,square) {
    // ...
}
```

这是一个绘制长方形的函数,但是其实绘制一个长方形只需要用到长和宽就可以了,这里最后一个参数完全是多余的,还有,如果以后这个函数变成需要画圆形,那么我们也可以将参数的长和宽转换成半径,但是面积始终应该由函数计算得出而不是参数传入的,另外,对于一些函数来说,有的地方可能会发生变化,但是大多数时候参数都是固定的,这时候我们可以用上面提到的传入默认对象参数的方式来定义默认参数.

- 避免因为'炫技'对之后的维护造成困难

这是什么意思呢,有一些程序员认为写一些炫酷的别人不理解的代码能体现自己的技术,比如说超长的三目运算符,他的理由是这能节省性能,或者说这能把代码压缩在一行内便于某些条件语句或者是参数的使用,我承认,三目运算符可能真的会比if快那么一点点,字节量可能也会少那么一丁丁,但是代码写出来是需要维护的,如果是一层的三目运算符还好说,如果是层层嵌套的超长的三目,恐怕就是写代码的本人日后自己来维护都需要花很长时间来理解了,而且三目运算符的单行改动很难不出错,说实话,在实际项目中,看到这种估计写的非常难读又没有什么实际的技术含量的代码,并不能让人觉得你的技术高超或者是对你产生钦佩,只会觉得这种行为很蠢,所以,除了单句的三目运算符之外,其它的情况请老老实实的使用if语句.

- 合理使用链式调用

jQuery的链式调用是为前端程序员所称赞的地方,其实在原生JS中也很容易实现链式调用,无非就在函数尾部将this作为返回值抛出,链式调用确实是是一种让人眼前一亮的模式,也可以很好的说明一个对象经历了什么,比如说一些前端构建工具经常使用链式调用的方式,维护的人在阅读这些代码的时候就能很容易的知道文件在哪一步做了哪些事情,但是要避免为了使用链式调用而使用它,因为在调试的时候很不方便,如果一条链很稳定,写了之后基本上很少会做出修改,比如说前端工作流的构建,这种时候我们应该使用链式调用,如果说一条链不稳定,某个环节易变的,那么就需要仔细考虑是否真的需要使用链式调用.

- 分解大型类

这里不细说,如果一个类过于庞大,那么需要仔细审视某些地方是不是真的有必要要这么写了.

- 用return退出多重循环