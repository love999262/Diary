- 闭包是一个对于新手程序员很难搞懂的概念,甚至很多自称中高级JS工程师也对此概念懵懵懂懂似懂非懂的,在我看来闭包是基础中的基础,可能对于写一些基础的业务代码来说很多时候并不会有非要使用闭包不可的场景,但是对于设计模式来说很多模式都利用了这一特性来实现的.

- 新手程序员对于此概念不了解或者很难理解的原因是因为要了解闭包必须先知道几个前置概念:作用域,作用域链,函数式编程,匿名函数.

- 作用域与作用域链:在JS中作用域就是指代变量的有效范围,而作用域链则是指变量的有效范围想一条锁链一样的从外到内的延伸.

```
    var test = function() {
        var a = 'scope1';
        var test2 = function() {
            var b = 'scope2';
            console.log(a);
            console.log(b);
        };
        test2();
        console.log(a);
        console.log(b);
    };
    test();
```
上面这段基础的代码解释了作用域:函数的内部的函数可以取到外部函数的变量,而外部函数不能取到内部函数的变量,所谓作用域链就是指内部函数可以一直向外部取到所需的变量的值直到全局环境为止.

- 变量的生存周期: 对于一个变量来说当我们需要用到它的时候它就会被声明,当不需要使用的时候它就会被标记等待回收,对于局部变量来说当退出函数时该变量就会被标记销毁但是有一些特例:

```
    var closure = function() {
        var a = 1;
        return function() {
            console.log(a);
        }
    }
    var b = closure();
    b(); // 1
```
这段代码中当我们退出函数之后变量a并没有消失,而是一直存在,这是因为当执行 b = closure()时b返回了一个匿名函数的引用,该匿名函数可以访问closure被调用时产生的环境,而局部变量a一直处于这个环境中,既然局部变量所在的环境可以被外部访问到,那么这个变量就不会被销毁,在这里就产生了一个闭包结构,局部变量的被续命了.

我们可以用闭包来做很多有意思的工作:

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        div {
            width: 100px;
            height: 100px;
            border: 1px solid #dadada;
        }
    </style>
</head>
<body>
    <div>1</div>
    <div>2</div>
    <div>3</div>
    <div>4</div>
    <div>5</div>
    <script type="text/javascript">
        var nodes = document.getElementsByTagName('div');
        var len = nodes.length
        for(var i = 0; i < len; i++) {
            nodes[i].onclick = function() {
                alert(i);
            };
        }
    </script>
</body>
</html>
```
执行这段糟糕的代码我们发现,无论点击哪个DIV我们都会看到最后弹出一个5,这是因为当点击的时候for循环早就已经结束了,此时变量i的值已经是执行完的最终结果5,我们可以用闭包来帮助保存现场:

```
    var nodes = document.getElementsByTagName('div');
    var len = nodes.length
    var hepler = function(i) {
        // i
        console.log(i);
        nodes[i].onclick = function() {
            console.log(i);
        };
    }
    for (var i = 0; i < len; i++) {
        hepler(i);
    }
    ||
    var nodes = document.getElementsByTagName('div');
    var len = nodes.length
    for(var i = 0; i < len; i++) {
        (function(i) {
            nodes[i].onclick = function() {
                alert(i);
            };
        })(i)
    }
```
上面两段代码是一样的,本质都是在执行for循环的时候将每次变量i的值传入一个闭包因为闭包中有方法在将来的某个时机需要用到变量i所以变量i并不会被销毁,因为作用域链的缘故,虽然for中的i最终是5但是helper中的i是闭包引用的值,也就是当时传入的i的值.

# more feature

- 封装变量


```

```
